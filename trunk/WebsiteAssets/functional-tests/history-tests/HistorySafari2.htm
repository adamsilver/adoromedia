<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Hash and history</title>
    <script type="text/javascript">
    var hashIndex = 0;
    var timerCookie, initialHistoryLength;
    
    function onLoad() {
        // Store the initial history length
        initialHistoryLength = history.length;

        // Set-up the polling:
        timerCookie = window.setTimeout(onTick, 200);
    }
    
    function onTick() {
        timerCookie = null;
        document.getElementById("currentHash").innerHTML = (getStateFromStack() || "null");
        timerCookie = window.setTimeout(onTick, 200);
    }

    function getStateStack() {
        // getting the stack from the field without validation for simplicity.
        // DON'T DO THIS AT HOME. Use a proper JSON deserializer instead.
        return eval(document.getElementById("historyStack").value);
    }

    function getStateFromStack() {
        return getStateStack()[history.length - initialHistoryLength - 1];
    }



    function storeToHistoryStack(state) {
        var stack = getStateStack();
        stack[history.length - initialHistoryLength] = state;
        // Doing some very basic serialization here without escaping for simplicity.
        // DON'T DO THIS AT HOME. Use a proper JSON serializer instead.
        document.getElementById("historyStack").value = "['" + stack.join("','") + "']";
    }


    function makeNewHash() {
        window.location.hash = hashIndex;
        storeToHistoryStack(hashIndex++);
    }
    
    function onUnload() {
        if (timerCookie) {
            window.clearTimeout(timerCookie);
        }
    }
    </script>
</head>
<body onload="onLoad()" onunload="onUnload()">
    <div>
        <input type="button" value="Generate new hash" onclick="makeNewHash()" />
        <h1>Current hash:</h1>
        <div id="currentHash"></div>
        <input type="text" id="historyStack" value="[]"/>
    </div>
</body>
</html>
